!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("path-browserify"),require("firebase/firestore"),require("firebase/storage"),require("lodash"),require("firebase/app"),require("firebase/auth")):"function"==typeof define&&define.amd?define(["exports","path-browserify","firebase/firestore","firebase/storage","lodash","firebase/app","firebase/auth"],r):r(e.reactAdminFirebase={},e.path,0,0,e.lodash,e.firebase)}(this,function(e,r,t,n,o,i){r=r&&r.hasOwnProperty("default")?r.default:r,i=i&&i.hasOwnProperty("default")?i.default:i;const a=function(){function e(){}return e.prototype.then=function(r,t){const n=new e,o=this.s;if(o){const e=1&o?r:t;if(e){try{s(n,1,e(this.v))}catch(e){s(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?s(n,1,r?r(o):o):t?s(n,1,t(o)):s(n,2,o)}catch(e){s(n,2,e)}},n},e}();function s(e,r,t){if(!e.s){if(t instanceof a){if(!t.s)return void(t.o=s.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(s.bind(null,e,r),s.bind(null,e,2));e.s=r,e.v=t;const n=e.o;n&&n(e)}}function u(e,r,t){var n,o,i=-1;return function u(c){try{for(;++i<e.length&&(!t||!t());)if((c=r(i))&&c.then){if(!((l=c)instanceof a&&1&l.s))return void c.then(u,o||(o=s.bind(null,n=new a,2)));c=c.v}n?s(n,1,c):n=c}catch(e){s(n||(n=new a),2,e)}var l}(),n}function c(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var l=function(){this.title="ðŸ”¥r-a-f: "},f={log:{configurable:!0},warn:{configurable:!0},error:{configurable:!0}};l.prototype.isEnabled=function(){return!!localStorage.getItem("LOGGING_ENABLED")},f.log.get=function(){return this.isEnabled()?console.log.bind(console,this.title):function(){for(var e=[],r=arguments.length;r--;)e[r]=arguments[r]}},f.warn.get=function(){return this.isEnabled()?console.warn.bind(console,this.title):function(){for(var e=[],r=arguments.length;r--;)e[r]=arguments[r]}},f.error.get=function(){return this.isEnabled()?console.error.bind(console,this.title):function(){for(var e=[],r=arguments.length;r--;)e[r]=arguments[r]}},Object.defineProperties(l.prototype,f);var d=new l;function h(e,r){e&&e.debug||r&&r.logging?localStorage.setItem("LOGGING_ENABLED","true"):localStorage.removeItem("LOGGING_ENABLED")}var p=d.log,m=d.warn,v=d.error;function y(e,r,t){e.sort(function(e,n){var i=o.get(e,r),a=o.get(n,r),s="asc"===t;return Number.isFinite(i)&&Number.isFinite(a)?g(i,a,s):"string"==typeof i&&"string"==typeof a?g(i.toLowerCase(),a.toLowerCase(),s):i instanceof Date&&a instanceof Date?g(i,a,s):g(!!i,!!a,s)})}function g(e,r,t){return e>r?t?1:-1:e<r?t?-1:1:0}function P(e,r){if(!r||o.isEmpty(r))return e;var t=[];return Object.keys(r).map(function(e){var n=function(e,r){if(!r)return[{searchField:e,searchValue:r}];var t={};return t[e]=r,function(e){var r=[],t=function(e,n){for(var o in n=n||"",e)if(e.hasOwnProperty(o)){var i=e&&e[o],a=n?n+"."+o:o;"object"==typeof i||i instanceof Array?t(i,a):r.push({searchField:a,searchValue:i})}};return t(e,null),r}(t)}(e,r[e]);t.push.apply(t,n)}),e.filter(function(e){return t.reduce(function(r,t){return function(e,r,n){var i=o.get(e,t.searchField);return!i&&!n||!!i&&("string"==typeof n?i.toString().toLowerCase().includes(n.toLowerCase()):("boolean"==typeof n||"number"==typeof n)&&i===n)}(e,0,t.searchValue)&&r},!0)})}var b=function(e,r){try{var t=!1,n=Array.isArray(r),o=!n&&"object"==typeof r,i=o&&r&&r.hasOwnProperty("src")?c(function(){return Promise.resolve(e.storage().ref(r.src).getDownloadURL()).then(function(e){return t=!0,Object.assign({},r,{src:e})})},function(e){return v("Error when getting download URL",{error:e}),t=!0,r}):function(){if(o){function i(){return t=!0,r}var a=function(t,n,o){var i=[];for(var a in t)i.push(a);return u(i,function(t){return function(t){var n=function(){if(r.hasOwnProperty(t))return Promise.resolve(b(e,r[t])).then(function(e){r[t]=e})}();if(n&&n.then)return n.then(function(){})}(i[t])},void 0)}(r);return a&&a.then?a.then(i):i()}return function(){if(n){function o(){return t=!0,r}var i=u(r,function(t){return Promise.resolve(b(e,r[t])).then(function(e){r[t]=e})});return i&&i.then?i.then(o):o()}}()}();return Promise.resolve(i&&i.then?i.then(function(e){return t?e:r}):t?i:r)}catch(e){return Promise.reject(e)}};function j(e,t){if(!e)return t+"";if(!t)throw new Error("Resource name must be a string of length greater than 0 characters");var n="string"==typeof e?e:e(),o=r.join("/",n,"/",t,"/");if((o.split("/").length-1)%2)throw new Error('The rootRef path must point to a "document" not a "collection"\ne.g. /collection/document/ or /collection/document/collection/document/');return o.slice(1,-1)}function w(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return r.join.apply(r,e)}var F=function(){this.firestore=null,this.app=null,this.options={}};F.prototype.GetApp=function(){return this.app},F.prototype.init=function(e,r){var t=r||{};this.options=t,this.app=function(e,r){return t.app?t.app:i.apps.length?i.app():i.initializeApp(e)}(e),this.firestore=this.app.firestore()},F.prototype.db=function(){return this.firestore},F.prototype.serverTimestamp=function(){return new Date},F.prototype.auth=function(){return this.app.auth()},F.prototype.storage=function(){return this.app.storage()},F.prototype.GetUserLogin=function(){try{var e=this;return Promise.resolve(new Promise(function(r,t){e.app.auth().onAuthStateChanged(function(e){e?r(e):t("getUserLogin() no user logged in")})}))}catch(e){return Promise.reject(e)}},F.prototype.OnUserLogout=function(e){this.app.auth().onAuthStateChanged(function(r){var t=!r;p("FirebaseWrapper.OnUserLogout",{user:r,isLoggedOut:t}),t&&e(r)})};var T=function(e,r){var t=this;this.fireWrapper=e,this.options=r,this.resources={},this.db=e.db(),this.fireWrapper.OnUserLogout(function(e){t.resources={}})};T.prototype.TryGetResource=function(e,r,t){try{var n=this;function o(){return n.TryGetResourcePromise(e,t)}var i=function(){if(r)return Promise.resolve(n.RefreshResource(e,t)).then(function(){})}();return Promise.resolve(i&&i.then?i.then(o):o())}catch(e){return Promise.reject(e)}},T.prototype.GetResource=function(e){var r=this.resources[e];if(!r)throw new Error('react-admin-firebase: Cant find resource: "'+e+'"');return r},T.prototype.TryGetResourcePromise=function(e,r){try{var t=this;return p("resourceManager.TryGetResourcePromise",{relativePath:e,collectionQuery:r}),Promise.resolve(t.initPath(e,r)).then(function(){var r=t.resources[e];if(!r)throw new Error('react-admin-firebase: Cant find resource: "'+e+'"');return r})}catch(e){return Promise.reject(e)}},T.prototype.RefreshResource=function(e,r){try{var t=this;return p("resourceManager.RefreshResource",{relativePath:e,collectionQuery:r}),Promise.resolve(t.initPath(e,r)).then(function(){var n=t.resources[e],o=n.collection,i=t.applyQuery(o,r);return Promise.resolve(i.get()).then(function(e){n.list=e.docs.map(function(e){return t.parseFireStoreDocument(e)}),p("resourceManager.RefreshResource",{newDocs:e,resource:n,collectionPath:o.path})})})}catch(e){return Promise.reject(e)}},T.prototype.GetSingleDoc=function(e,r){try{var t=this;return Promise.resolve(t.initPath(e)).then(function(){var n=t.resources[e];return Promise.resolve(n.collection.doc(r).get()).then(function(o){if(!o.exists)throw new Error("react-admin-firebase: No id found matching: "+r);var i=t.parseFireStoreDocument(o);return p("resourceManager.GetSingleDoc",{relativePath:e,resource:n,docId:r,docSnap:o,result:i}),i})})}catch(e){return Promise.reject(e)}},T.prototype.initPath=function(e,r){try{var t=j(this.options&&this.options.rootRef,e),n=!!this.resources[e];if(p("resourceManager.initPath()",{absolutePath:t,hasBeenInited:n}),n)return p("resourceManager.initPath() has been initialized already..."),Promise.resolve();var o=this.db.collection(t),i={collection:o,list:[],path:e,pathAbsolute:t};return this.resources[e]=i,p("resourceManager.initPath() setting resource...",{resource:i,allResources:this.resources,collection:o,collectionPath:o.path}),Promise.resolve()}catch(e){return Promise.reject(e)}},T.prototype.parseFireStoreDocument=function(e){if(!e)return m("parseFireStoreDocument: no doc",{doc:e}),{};var r,t=e.data();return(r=t)&&"object"==typeof r&&Object.keys(r).map(function(e){r[e]=function e(r){return r?"object"!=typeof r?r:r.toDate&&"function"==typeof r.toDate?r.toDate():Array.isArray(r)?r.map(function(r){return e(r)}):"object"==typeof r?(Object.keys(r).map(function(t){r[t]=e(r[t])}),r):void 0:r}(r[e])}),Object.assign({},{id:e.id},t)},T.prototype.getUserIdentifier=function(){try{return Promise.resolve(this.options.associateUsersById?this.getCurrentUserId():this.getCurrentUserEmail())}catch(e){return Promise.reject(e)}},T.prototype.getCurrentUserEmail=function(){try{return Promise.resolve(this.fireWrapper.GetUserLogin()).then(function(e){return e?e.email:"annonymous user"})}catch(e){return Promise.reject(e)}},T.prototype.getCurrentUserId=function(){try{return Promise.resolve(this.fireWrapper.GetUserLogin()).then(function(e){return e?e.uid:"annonymous user"})}catch(e){return Promise.reject(e)}},T.prototype.removeResource=function(e){delete this.resources[e]},T.prototype.applyQuery=function(e,r){var t;return t=r?r(e):e,p("resourceManager.applyQuery() ...",{collection:e,collectionQuery:(r||"-").toString(),collref:t}),t};var A=function(e,r){this.fireWrapper=e,this.options=r,this.rm=new T(this.fireWrapper,this.options)};A.prototype.db=function(){return this.fireWrapper.db()},A.prototype.checkRemoveIdField=function(e){this.options.dontAddIdFieldToDoc&&delete e.id},A.prototype.parseDataAndUpload=function(e,r,t){try{var n=this;if(!t)return Promise.resolve(t);var i=e.collection.doc(r).path,a=function(e){if(!e||"object"!=typeof e)return[];var r=[];return Object.keys(e).map(function(t){!function e(r,t,n){return r?"object"!=typeof r?r:r.toDate&&"function"==typeof r.toDate?r.toDate():Array.isArray(r)?r.map(function(r,o){return e(r,t+"."+o,n)}):"object"==typeof r?r&&r.hasOwnProperty("rawFile")?(n.push({fieldDotsPath:t,fieldSlashesPath:t.split(".").join("/"),rawFile:r.rawFile}),void delete r.rawFile):(Object.keys(r).map(function(o){e(r[o],t+"."+o,n)}),r):void 0:r}(e[t],t,r)}),r}(t);return Promise.resolve(Promise.all(a.map(function(e){try{return Promise.resolve(n.uploadAndGetLink(e.rawFile,i,e.fieldSlashesPath,!!n.options.useFileNamesInStorage)).then(function(r){o.set(t,e.fieldDotsPath+".src",r)})}catch(e){return Promise.reject(e)}}))).then(function(){return t})}catch(e){return Promise.reject(e)}},A.prototype.addCreatedByFields=function(e){try{return Promise.resolve(function(e,r,t,n){try{return n.disableMeta?Promise.resolve():Promise.resolve(t.getUserIdentifier()).then(function(t){var o=function(e){if(e.renameMetaFields&&e.renameMetaFields.created_at)return e.renameMetaFields.created_at;var r=e.metaFieldCasing;return r?"camel"===r?"createDate":"snake"===r?"create_date":"pascal"===r?"CreateDate":"kebab"===r?"create-date":"createdate":"createdate"}(n),i=function(e){if(e.renameMetaFields&&e.renameMetaFields.created_by)return e.renameMetaFields.created_by;var r=e.metaFieldCasing;return r?"camel"===r?"createdBy":"snake"===r?"created_by":"pascal"===r?"CreatedBy":"kebab"===r?"created-by":"createdby":"createdby"}(n);e[o]=r.serverTimestamp(),e[i]=t})}catch(e){return Promise.reject(e)}}(e,this.fireWrapper,this.rm,this.options))}catch(e){return Promise.reject(e)}},A.prototype.addUpdatedByFields=function(e){try{return Promise.resolve(function(e,r,t,n){try{return n.disableMeta?Promise.resolve():Promise.resolve(t.getUserIdentifier()).then(function(t){var o=function(e){if(e.renameMetaFields&&e.renameMetaFields.updated_at)return e.renameMetaFields.updated_at;var r=e.metaFieldCasing;return r?"camel"===r?"lastUpdate":"snake"===r?"last_update":"pascal"===r?"LastUpdate":"kebab"===r?"last-update":"lastupdate":"lastupdate"}(n),i=function(e){if(e.renameMetaFields&&e.renameMetaFields.updated_by)return e.renameMetaFields.updated_by;var r=e.metaFieldCasing;return r?"camel"===r?"updatedBy":"snake"===r?"updated_by":"pascal"===r?"UpdatedBy":"kebab"===r?"updated-by":"updatedby":"updatedby"}(n);e[o]=r.serverTimestamp(),e[i]=t})}catch(e){return Promise.reject(e)}}(e,this.fireWrapper,this.rm,this.options))}catch(e){return Promise.reject(e)}},A.prototype.uploadAndGetLink=function(e,r,t,n){try{var o=n?w(r,t,e.name):w(r,t);return Promise.resolve(this.saveFile(o,e))}catch(e){return Promise.reject(e)}},A.prototype.saveFile=function(e,r){try{var t=this;p("saveFile() saving file...",{storagePath:e,rawFile:r});var n=t.fireWrapper.storage().ref(e).put(r);return Promise.resolve(c(function(){return Promise.resolve(new Promise(function(e,r){return n.then(e).catch(r)})).then(function(r){return Promise.resolve(r.ref.getDownloadURL()).then(function(n){return p("saveFile() saved file",{storagePath:e,taskResult:r,getDownloadURL:n}),t.options.relativeFilePaths?e:n})})},function(e){v("storage/unknown"===e.code?'saveFile() error saving file, No bucket found! Try clicking "Get Started" in firebase -> storage':"saveFile() error saving file",{storageError:e})}))}catch(e){return Promise.reject(e)}};var R=function(e,r){var t=r||{};p("Auth Client: initializing...",{firebaseConfig:e,options:t});var n=new F;n.init(e,t),this.auth=n.auth(),t.persistence&&this.setPersistence(t.persistence)};R.prototype.setPersistence=function(e){var r;switch(e){case"local":r=i.auth.Auth.Persistence.LOCAL;break;case"none":r=i.auth.Auth.Persistence.NONE;break;case"session":default:r=i.auth.Auth.Persistence.SESSION}p("setPersistence",{persistenceInput:e,persistenceResolved:r}),this.auth.setPersistence(r).catch(function(e){return console.error(e)})},R.prototype.HandleAuthLogin=function(e){try{var r=this,t=e.username,n=e.password;return t&&n?Promise.resolve(c(function(){return Promise.resolve(r.auth.signInWithEmailAndPassword(t,n)).then(function(e){return p("HandleAuthLogin: user sucessfully logged in",{user:e}),e})},function(){throw p("HandleAuthLogin: invalid credentials",{params:e}),new Error("Login error: invalid credentials")})):Promise.resolve(r.getUserLogin())}catch(e){return Promise.reject(e)}},R.prototype.HandleAuthLogout=function(){return this.auth.signOut()},R.prototype.HandleAuthError=function(e){return p("HandleAuthLogin: invalid credentials",{errorHttp:e}),"ok"===function(e){if(e>=200&&e<300)return"ok";switch(e){case 401:case 403:return"unauthenticated";case 0:case 400:case 404:case 409:case 429:case 499:case 500:case 501:case 503:case 504:default:return"ok"}}(!!e&&e.status)?(p("API is actually authenticated"),Promise.resolve()):(m("Recieved authentication error from API"),Promise.reject())},R.prototype.HandleAuthCheck=function(){try{return Promise.resolve(this.getUserLogin())}catch(e){return Promise.reject(e)}},R.prototype.getUserLogin=function(){var e=this;return new Promise(function(r,t){if(e.auth.currentUser)return r(e.auth.currentUser);var n=e.auth.onAuthStateChanged(function(e){n(),e?r(e):t()})})},R.prototype.HandleGetPermissions=function(){try{var e=this;return Promise.resolve(c(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.claims})})},function(e){return p("HandleGetPermission: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},R.prototype.HandleGetIdentity=function(){try{var e=this;return Promise.resolve(c(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return{id:e.uid,fullName:e.displayName+"",avatar:e.photoURL+""}})},function(e){return p("HandleGetIdentity: no user is logged in",{e:e}),null}))}catch(e){return Promise.reject(e)}},R.prototype.HandleGetJWTAuthTime=function(){try{var e=this;return Promise.resolve(c(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.authTime})})},function(e){return p("HandleGetJWTAuthTime: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},R.prototype.HandleGetJWTExpirationTime=function(){try{var e=this;return Promise.resolve(c(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.expirationTime})})},function(e){return p("HandleGetJWTExpirationTime: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},R.prototype.HandleGetJWTSignInProvider=function(){try{var e=this;return Promise.resolve(c(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.signInProvider})})},function(e){return p("HandleGetJWTSignInProvider: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},R.prototype.HandleGetJWTIssuedAtTime=function(){try{var e=this;return Promise.resolve(c(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.issuedAtTime})})},function(e){return p("HandleGetJWTIssuedAtTime: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},R.prototype.HandleGetJWTToken=function(){try{var e=this;return Promise.resolve(c(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.token})})},function(e){return p("HandleGetJWTIssuedAtTime: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},e.FirebaseDataProvider=function(e,r){var t=function(e){try{var r;return Promise.resolve(c(function(){return Promise.resolve(e()).then(function(e){return r=e})},function(e){var t=e.toString(),n=function(e){var r=/\[code\=([\w-]*)/g.exec(e),t=Array.isArray(r)&&r[1];switch(t||v("unknown StatusCode ",{statusTxt:e}),t){case"unauthenticated":return 401;case"permission-denied":return 403;case"internal":return 0;case"invalid-argument":return 400;case"not-found":return 404;case"aborted":return 409;case"resource-exhausted":return 429;case"cancelled":return 499;case"internal":return 500;case"unimplemented":return 501;case"unavailable":return 503;case"deadline-exceeded":return 504;default:return 200}}(t),o={status:n,message:t,json:r};throw v("DataProvider:",e,{errorMsg:t,code:n,errorObj:o}),o}))}catch(e){return Promise.reject(e)}},n=r||{};!function(e,r){if(!(e||r&&r.app))throw new Error("Please pass the Firebase firebaseConfig object or options.app to the FirebaseAuthProvider");r&&r.rootRef&&j(r.rootRef,"test")}(e,n),h(e,n),p("react-admin-firebase:: Creating FirebaseDataProvider",{firebaseConfig:e,options:n});var o=new F;o.init(e,r);var i=new A(o,n);return{app:o.GetApp(),getList:function(e,r){return t(function(){return function(e,r,t){try{p("GetList",{resourceName:e,params:r});var n=t.rm,o=t.fireWrapper,i=t.options,a=r.filter||{},s=a.collectionQuery;return delete a.collectionQuery,Promise.resolve(n.TryGetResource(e,"REFRESH",s)).then(function(e){var t=!1;function n(e){return t?e:{data:d,total:h}}var s=e.list;if(null!=r.sort){var u=r.sort;y(s,u.field,"ASC"===u.order?"asc":"desc")}var c=s;i.softDelete&&!Object.keys(a).includes("deleted")&&(c=s.filter(function(e){return!e.deleted}));var l=P(c,a),f=(r.pagination.page-1)*r.pagination.perPage,d=l.slice(f,f+r.pagination.perPage),h=l.length,p=function(){if(i.relativeFilePaths)return Promise.resolve(Promise.all(d.map(function(e){return b(o,e)}))).then(function(e){return t=!0,{data:e,total:h}})}();return p&&p.then?p.then(n):n(p)})}catch(e){return Promise.reject(e)}}(e,r,i)})},getOne:function(e,r){return t(function(){return function(e,r,t){try{p("GetOne",{resourceName:e,params:r});var n=t.rm,o=t.fireWrapper;return Promise.resolve(c(function(){return Promise.resolve(n.GetSingleDoc(e,r.id+"")).then(function(e){return Promise.resolve(b(o,e)).then(function(e){return{data:e}})})},function(){throw new Error("Error getting id: "+r.id+" from collection: "+e)}))}catch(e){return Promise.reject(e)}}(e,r,i)})},getMany:function(e,r){return t(function(){return function(e,r,t){try{var n=t.options,o=t.fireWrapper;return Promise.resolve(t.rm.TryGetResource(e)).then(function(t){return p("GetMany",{resourceName:e,resource:t,params:r}),Promise.resolve(Promise.all(r.ids.map(function(e){return t.collection.doc(e+"").get()}))).then(function(e){var r=!1;function t(e){return r?e:{data:a}}var i=e.map(function(e){return Object.assign({},e.data(),{id:e.id})}),a=n.softDelete?i.filter(function(e){return!e.deleted}):i,s=function(){if(n.relativeFilePaths)return Promise.resolve(Promise.all(a.map(function(e){return b(o,e)}))).then(function(e){return r=!0,{data:e}})}();return s&&s.then?s.then(t):t(s)})})}catch(e){return Promise.reject(e)}}(e,r,i)})},getManyReference:function(e,r){return t(function(){return function(e,r,t){try{var n=t.rm,o=t.options,i=t.fireWrapper;p("GetManyReference",{resourceName:e,params:r});var a=r.filter||{};return Promise.resolve(n.TryGetResource(e,"REFRESH",a.collectionQuery)).then(function(t){var n=!1;function s(e){return n?e:{data:j,total:w}}delete a.collectionQuery,p("apiGetManyReference",{resourceName:e,resource:t,params:r});var u=t.list,c=r.target,l=r.id,f=u;o.softDelete&&(f=u.filter(function(e){return!e.deleted}));var d=P(f,a),h={};h[c]=l;var m=P(d,h);if(null!=r.sort){var v=r.sort;y(m,v.field,"ASC"===v.order?"asc":"desc")}var g=(r.pagination.page-1)*r.pagination.perPage,j=m.slice(g,g+r.pagination.perPage),w=m.length,F=function(){if(o.relativeFilePaths)return Promise.resolve(Promise.all(m.map(function(e){return b(i,e)}))).then(function(e){return n=!0,{data:e,total:w}})}();return F&&F.then?F.then(s):s(F)})}catch(e){return Promise.reject(e)}}(e,r,i)})},update:function(e,r){return t(function(){return function(e,r,t){try{var n=t.rm;p("Update",{resourceName:e,params:r});var o=r.id+"";return delete r.data.id,Promise.resolve(n.TryGetResource(e)).then(function(n){return p("Update",{resourceName:e,resource:n,params:r}),Promise.resolve(t.parseDataAndUpload(n,o,r.data)).then(function(e){var r=Object.assign({},e);return t.checkRemoveIdField(r),Promise.resolve(t.addUpdatedByFields(r)).then(function(){return Promise.resolve(n.collection.doc(o).update(r)).then(function(){return{data:Object.assign({},e,{id:o})}})})})})}catch(e){return Promise.reject(e)}}(e,r,i)})},updateMany:function(e,r){return t(function(){return function(e,r,t){try{var n=t.rm;return p("UpdateMany",{resourceName:e,params:r}),delete r.data.id,Promise.resolve(n.TryGetResource(e)).then(function(n){return p("UpdateMany",{resourceName:e,resource:n,params:r}),Promise.resolve(Promise.all(r.ids.map(function(e){try{var o=e+"";return Promise.resolve(t.parseDataAndUpload(n,o,r.data)).then(function(e){var r=Object.assign({},e);return t.checkRemoveIdField(r),Promise.resolve(t.addUpdatedByFields(r)).then(function(){return Promise.resolve(n.collection.doc(o).update(r)).then(function(){return Object.assign({},e,{id:o})})})})}catch(e){return Promise.reject(e)}}))).then(function(e){return{data:e}})})}catch(e){return Promise.reject(e)}}(e,r,i)})},create:function(e,r){return t(function(){return function(e,r,t){try{var n=t.fireWrapper;return Promise.resolve(t.rm.TryGetResource(e)).then(function(o){var i=!1;function a(e){if(i)return e;var a=n.db().collection("collections").doc().id;return Promise.resolve(t.parseDataAndUpload(o,a,r.data)).then(function(e){var r=Object.assign({},e);return t.checkRemoveIdField(r),Promise.resolve(t.addCreatedByFields(r)).then(function(){return Promise.resolve(t.addUpdatedByFields(r)).then(function(){return Promise.resolve(o.collection.doc(a).set(r,{merge:!1})).then(function(){return{data:Object.assign({},e,{id:a})}})})})})}p("Create",{resourceName:e,resource:o,params:r});var s=r.data&&r.data.id;p("Create",{hasOverridenDocId:s});var u=function(){if(s){var e=r.data.id;return Promise.resolve(o.collection.doc(e).get()).then(function(n){if(n.exists)throw new Error('the id:"'+e+"\" already exists, please use a unique string if overriding the 'id' field");return Promise.resolve(t.parseDataAndUpload(o,e,r.data)).then(function(r){if(!e)throw new Error("id must be a valid string");var n=Object.assign({},r);return t.checkRemoveIdField(n),Promise.resolve(t.addCreatedByFields(n)).then(function(){return Promise.resolve(t.addUpdatedByFields(n)).then(function(){return p("Create",{docObj:n}),Promise.resolve(o.collection.doc(e).set(n,{merge:!1})).then(function(){return i=!0,{data:Object.assign({},r,{id:e})}})})})})})}}();return u&&u.then?u.then(a):a(u)})}catch(e){return Promise.reject(e)}}(e,r,i)})},delete:function(e,r){return t(function(){return function(e,r,t){try{var n=t.rm;return t.options.softDelete?Promise.resolve(function(e,r,t){try{var n=r.id+"";return Promise.resolve(t.rm.TryGetResource(e)).then(function(o){p("DeleteSoft",{resourceName:e,resource:o,params:r});var i={deleted:!0};return Promise.resolve(t.addUpdatedByFields(i)).then(function(){return o.collection.doc(n).update(i).catch(function(e){v("DeleteSoft error",{error:e})}),{data:r.previousData}})})}catch(e){return Promise.reject(e)}}(e,r,t)):Promise.resolve(n.TryGetResource(e)).then(function(t){function n(e){return{data:r.previousData}}p("apiDelete",{resourceName:e,resource:t,params:r});var o=c(function(){return Promise.resolve(t.collection.doc(r.id+"").delete()).then(function(){})},function(e){throw new Error(e)});return o&&o.then?o.then(n):n()})}catch(e){return Promise.reject(e)}}(e,r,i)})},deleteMany:function(e,r){return t(function(){return function(e,r,t){try{var n=t.rm,o=t.fireWrapper;return t.options.softDelete?Promise.resolve(function(e,r,t){try{return Promise.resolve(t.rm.TryGetResource(e)).then(function(n){return p("DeleteManySoft",{resourceName:e,resource:n,params:r}),Promise.resolve(Promise.all(r.ids.map(function(e){try{var r=e+"",o={deleted:!0};return Promise.resolve(t.addUpdatedByFields(o)).then(function(){return n.collection.doc(r).update(o).catch(function(e){v("apiSoftDeleteMany error",{error:e})}),r})}catch(e){return Promise.reject(e)}}))).then(function(e){return{data:e}})})}catch(e){return Promise.reject(e)}}(e,r,t)):Promise.resolve(n.TryGetResource(e)).then(function(t){function n(e){return{data:i}}p("DeleteMany",{resourceName:e,resource:t,params:r});for(var i=[],a=o.db().batch(),s=0,u=r.ids;s<u.length;s+=1){var l=u[s],f=t.collection.doc(l+"");a.delete(f),i.push(l)}var d=c(function(){return Promise.resolve(a.commit()).then(function(){})},function(e){throw new Error(e)});return d&&d.then?d.then(n):n()})}catch(e){return Promise.reject(e)}}(e,r,i)})}}},e.FirebaseAuthProvider=function(e,r){!function(e,r){if(!(e||r&&r.app))throw new Error("Please pass the Firebase firebaseConfig object or options.app to the FirebaseAuthProvider")}(e,r);var t=new R(e,r);return h(e,r),{login:function(e){return t.HandleAuthLogin(e)},logout:function(){return t.HandleAuthLogout()},checkAuth:function(){return t.HandleAuthCheck()},checkError:function(e){return t.HandleAuthError(e)},getPermissions:function(){return t.HandleGetPermissions()},getIdentity:function(){return t.HandleGetIdentity()},getAuthUser:function(){return t.getUserLogin()},getJWTAuthTime:function(){return t.HandleGetJWTAuthTime()},getJWTExpirationTime:function(){return t.HandleGetJWTExpirationTime()},getJWTSignInProvider:function(){return t.HandleGetJWTSignInProvider()},getJWTClaims:function(){return t.HandleGetPermissions()},getJWTToken:function(){return t.HandleGetJWTToken()}}}});
//# sourceMappingURL=index.umd.js.map
